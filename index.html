<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Peasant Character Generator</title>
        <style>
            body { font-family: sans-serif; margin: 20px; background: #f4f4f9; }
            h1 { text-align: center; }
            .controls { text-align: center; margin-bottom: 20px; }
            button { padding: 10px 15px; margin: 5px; cursor: pointer; border-radius: 6px; }
            #characters { display: flex; flex-direction: column; gap: 10px; }
            .character-card { display: block; border: 1px solid #ccc; padding: 6px 8px; font-size: 1em; line-height: 1.2em; width: 100%; }
            .abilities, .skills { margin-top: 10px; }
            .abilties p { margin: 2px 0; }
            .skills label { display: inline-block; width: 200px; }
            .stats-block { margin-bottom: 0.5em; font-size: 0.9em; }
            .abilities-row { display: flex; flex-wrap: wrap; gap: 4px; font-size: 1em; }
            .ability-box, .skill-box { padding: 2px 4px; display: flex; align-items: center; font-size: 1em; }
            .skills-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 2px 6px; font-size: 1em; }
            .equipment-block, .attacks-block, .trinket-block { margin-top: 4px; font-size: 1em; }
            .char-subtitle { margin: -8px 0 10px 0; font-size: 1.1em; font-style: italic; color: #555; }
        </style>
    </head>
    <body>
          <!-- Navigation -->
        <nav>
        <ul>
            <li><a href="index.html">Characters</a></li>
            <li><a href="campaign.html">Campaign Hook</a></li>
            <li><a href="rules.html">Player Guide</a></li>
        </ul>
        </nav>

        <h1>Peasant Generator</h1>
        <div class="controls">
            <button onclick="generateCharacter()">Generate Peasant</button>
            <button onclick="exportPDF()">Export to PDF</button>
            <button onclick="clearCharacters()">Clear All</button>
        </div>

        <div id="characters"></div>

        <!-- jsPDF library for PDF export-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script>
            const { jsPDF } = window.jspdf;

            // Roll tables
            const ancestries = {
                "Dragonborn": ["Breath Weapon", "Draconic Ancestry"],
                "Gnome": ["Darkvision", "Gnome cunning", "Small size", "Walking speed of 25 ft"],
                "Gnome": ["Darkvision", "Gnome cunning", "Small size", "Walking speed of 25 ft"],
                "Half-orc": ["Darkvision", "Relentless endurance"],
                "Half-orc": ["Darkvision", "Relentless endurance"],
                "Dwarf": ["Darkvision", "Dwarven resilience", "Walking speed of 25 ft"],
                "Dwarf": ["Darkvision", "Dwarven resilience", "Walking speed of 25 ft"],
                "Human": ["No changes, you're playing on hard mode!"],
                "Human": ["No changes, you're playing on hard mode!"],
                "Elf": ["Darkvision", "Fey Ancestry"],
                "Elf": ["Darkvision", "Fey Ancestry"],
                "Half-elf": ["Darkvision", "Fey Ancestry"],
                "Half-elf": ["Darkvision", "Fey Ancestry"],
                "Halfling": ["Lucky", "Halfling nimbleness", "Small size", "Walking speed of 25 ft"],
                "Halfling": ["Lucky", "Halfling nimbleness", "Small size", "Walking speed of 25 ft"],
                "Tiefling": ["Darkvision", "Hellish Resistance"]
            };
            const occupations = {
                "Actor": {equipment: [
                    {name: "Longsword", type: "weapon", ability: "Strength", damage: {oneHand: "1d8", twoHand: "1d10"}, properties: "versatile", damageType: "slashing"}, 
                    {name: "disguise kit", type: "tool"},
                    {name: "set of assorted wigs", type: "tool"}]},
                "Alchemist's Apprentice": {equipment: [
                    {name: "Vials of explosive liquid", ammo: 4, type: "weapon", ability: "Dexterity", range: "20 feet", damage: "1d4", damageType: "fire"},
                    {name: "spell component pouch", type: "tool"}]}, 
                "Astrologer": {equipment: [
                    {name: "Quarterstaff", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: "versatile", damageType: "bludgeoning"},
                    {name: "pocket telescope", type: "tool"}]}, 
                "Big-game hunter": {equipment: [
                    {name: "Longbow", ammo: 20, type: "weapon", ability: "Dexterity", range: "150/600 feet", damage: "1d8", damageType: "piercing"},
                    {name: "pelt of an unusual creature", type: "flavor"}]},  
                "Blacksmith": {equipment: [
                    {name: "Hammer", type: "weapon", ability: "Strength", damage: "1d4", damageType: "bludgeoning"}, 
                    {name: "smith's tools", type: "tool"}]}, 
                "Brewer": {equipment: [
                    {name: "Huge metal spoon", type: "weapon", ability: "Strength", damage: "1d6", damageType: "bludgeoning"}, 
                    {name: "cask of ale", type: "flavor"}]},
                "Burglar": {equipment: [
                    {name: "Crowbar", type: "weapon", ability: "Strength", damage: "1d6", damageType: "bludgeoning"},
                    {name: "50 feet of hempen rope", type: "equipment"}]},
                "Busker": {equipment: [
                    {name: "Shortsword", type: "weapon", ability: "Strength", damage: "1d6", properties: ["finesse", "light"], damageType: "piercing"},
                    {name: "lute", type: "instrument"}]},
                "Butcher": {equipment: [
                    {name: "Cleaver", type: "weapon", ability: "Strength", damage: "1d6", damageType: "slashing"},
                    {name: "assorted bones", type: "flavor"}]},
                "Candle lighter": {equipment: [
                    {name: "Club", type: "weapon", ability: "Strength", damage: "1d4", damageType: "bludgeoning"}, 
                    "flint and steel"]},
                "Church usher": {equipment: [
                    {name: "Cudgel", type: "weapon", ability: "Strength", damage: "1d4", damageType: "bludgeoning"}, 
                    {name: "fine robes", type: "clothing"}]},
                "Circus performer": {equipment: [
                    {name: "Quarterstaff", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: "versatile", damageType: "bludgeoning"},
                    {name: "100 feet of hempen rope", type: "equipment"}]},
                "Confidence artist": {equipment: [
                    {name: "Dagger", type: "weapon", ability: "Strength", damage: "1d4", properties: ["finesse", "light", "thrown (range 20 / 60 feet)"], damageType: "piercing"},
                    {name: "set of cups and balls", type: "flavor"}]},
                "Cooper": {equipment: [
                    {name: "Crowbar", type: "weapon", ability: "Strength", damage: "1d4", damageType: "bludgeoning"}, 
                    {name: "empty barrel", type: "flavor"}]},
                "Court jester": {equipment: [
                    {name: "Sling", ammo: 10, type: "weapon", ability: "Dexterity", range: "30/120 feet", damage: "1d4", damageType: "bludgeoning"}, 
                    {name: "set of heavy juggling balls", type: "flavor"}]},
                "Farmer": {equipment: [
                    {name: "Pitchfork", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: ["versatile", "thrown (range 20/60 feet)"], damageType: "piercing"},
                    {name: "riding horse or woodworker's tools", type: "tools"}]},
                "Field hand": {equipment: [
                    {name: "Sickle", type: "weapon", ability: "Strength", damage: "1d4", properties: "light", damageType: "slashing"},
                    {name: "bag of grain", type: "flavor"}]},
                "Gravedigger": {equipment: [
                    {name: "Shovel", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: "versatile", damageType: "bludgeoning"},
                    {name: "large sack", type: "flavor"}]},
                "Grocer": {equipment: [
                    {name: "Knife", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: "versatile", damageType: "piercing"},
                    {name: "small set of brass scales", type: "flavor"}]},
                "Healer": {equipment: [
                    {name: "Scepter", type: "weapon", ability: "Strength", damage: "1d6", damageType: "bludgeoning"},
                    {name: "holy water", type: "flavor"}]},
                "Herbalist": {equipment: [
                    {name: "Sling", ammo: 10, type: "weapon", ability: "Dexterity", range: "30/120 feet", damage: "1d4", damageType: "bludgeoning"}, 
                    {name: "pouch of herbs", type: "flavor"}]},
                "Jeweler": {equipment: [
                    {name: "Small rock pick", type: "weapon", ability: "Strength", damage: "1d6", properties: ["light", "thrown (range 20/60 feet)"], damageType: "slashing"},
                    {name: "assorted gemstones worth 20sp", type: "flavor"}]},
                "Lighthouse keeper": {equipment: [
                    {name: "Spear", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: ["versatile", "thrown (range 20/60 feet)"], damageType: "piercing"},
                    {name: "hooded lantern", type: "equipment"},
                    {name: "flask of oil", type: "equipment"}]},
                "Locksmith": {equipment: [
                    {name: "Crowbar", type: "weapon", ability: "Strength", damage: "1d6", damageType: "bludgeoning"},
                    {name: "set of lockpicks", type: "equipment"}]},
                "Lumberjack": {equipment: [
                    {name: "Handaxe", type: "weapon", ability: "Strength", damage: "1d6", properties: ["light", "thrown (range 20/60 feet)"], damageType: "slashing"},
                    {name: "10-foot pole", type: "flavor"}]},
                "Mage's apprentice": {equipment: [
                    {name: "Quarterstaff", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: "versatile", damageType: "bludgeoning"},
                     "spell scroll of minor illusion"]}, 
                "Man-at-arms": {equipment: [
                    {name: "Longsword", type: "weapon", ability: "Strength", damage: {oneHand: "1d8", twoHand: "1d10"}, properties: "versatile", damageType: "slashing"},
                    {armor: {desc: "chain shirt", type: "medium", base: 13}}]},
                "Mercenary": {equipment: [
                    {name: "Shortbow", ammo: 20, type: "weapon", ability: "Dexterity", range: "80/230 feet", damage: "1d6", damageType: "piercing"},
                    {armor: {desc: "leather armor", type: "light", base: 11}}]}, 
                "Militia officer": {equipment: [
                    {name: "Longsword", type: "weapon", ability: "Strength", damage: {oneHand: "1d8", twoHand: "1d10"}, properties: "versatile", damageType: "slashing"},
                    {armor: {desc: "buckler shield", type: "shield"}}]},
                "Navigator": {equipment: [
                    {name: "Shortsword", type: "weapon", ability: "Strength", damage: "1d6", properties: ["finesse", "light"], damageType: "piercing"},
                    {name: "scroll case containing nautical charts", type: "flavor"}]},
                "Net maker": {equipment: [
                    {name: "Knife", type: "weapon", ability: "Strength", damage: "1d4", properties: ["finesse", "light", "thrown (range 20 / 60 feet)"], damageType: "piercing"},
                    {name: "net", type: "equipment"}]},
                "Noble": {equipment: [
                    {name: "Longsword", type: "weapon", ability: "Strength", damage: {oneHand: "1d8", twoHand: "1d10"}, damageType: "slashing"},
                    {name: "gold amulet worth 10 gp", type: "flavor"}]},
                "Pickpocket": {equipment: [
                    {name: "Dagger", type: "weapon", ability: "Strength", damage: "1d4", properties: ["finesse", "light", "thrown (range 20 / 60 feet)"], damageType: "piercing"},
                    {name: "disguise kit", type: "equipment"}]},
                "Pie maker": {equipment: [
                    {name: "Cleaver", type: "weapon", ability: "Strength", damage: "1d6", properties: ["light", "thrown (range 20/60 feet)"], damageType: "slashing"},
                    {name: "two bags of flour", type: "flavor"}]},
                "Pit-fighting champion": {equipment: [
                    {name: "Club", type: "weapon", ability: "Strength", damage: "1d4", properties: ["light"], damageType: "bludgeoning"},
                    {name: "10 feet of chain", type: "equipment"}]},
                "Priest": {equipment: [
                    {name: "Mace", type: "weapon", ability: "Strength", damage: "1d6", damageType: "bludgeoning"},
                    {name: "Sacred Flame spell scroll", type: "scroll"}]},
                "Scribe": {equipment: [
                    {name: "Quill knife", type: "weapon", ability: "Strength", damage: "1d4", properties: ["finesse", "light", "thrown (range 20 / 60 feet)"], damageType: "piercing"},
                    {name: "10 sheets of parchment", type: "flavor"}]},
                "Sculptor": {equipment: [
                    {name: "Chisel", type: "weapon", ability: "Strength", damage: "1d4", properties: ["finesse", "light", "thrown (range 20 / 60 feet)"], damageType: "piercing"},
                    {name: "bag filled with clay", type: "flavor"}]},
                "Snitch": {equipment: [
                    {name: "Club", type: "weapon", ability: "Strength", damage: "1d4", versatile: false, damageType: "bludgeoning"}, 
                    {name: "ragged cloak", type: "clothing"}]},
                "Soldier": {equipment: [
                    {name: "Spear", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: ["versatile", "thrown (range 20/60 feet)"], damageType: "piercing"}, 
                    {armor: {desc: "hide armor", type: "medium", base: 12}}]},
                "Soothsayer": {equipment: [
                    {name: "Hand-carved bone club", type: "weapon", ability: "Strength", damage: "1d4", versatile: false, damageType: "bludgeoning"}, 
                    {name: "divination items", type: "flavor"}]},
                "Squire": {equipment: [
                    {name: "Shortsword", type: "weapon", ability: "Strength", damage: "1d6", properties: ["finesse", "light"], damageType: "piercing"},
                    {name: "fine clothes", type: "clothing"}]},
                "Statue polisher": {equipment: [
                    {name: "Chisel", type: "weapon", ability: "Strength", damage: "1d4", properties: ["finesse", "light", "thrown (range 20 / 60 feet)"], damageType: "piercing"},
                    {name: "portable ladder", type: "equipment"}]},
                "Tavern bouncer": {equipment: [
                    {name: "Cudgel", type: "weapon", ability: "Strength", damage: "1d4", versatile: false, damageType: "bludgeoning"}, 
                    {armor: {desc: "padded armor", type: "light", base: 11}}]},
                "Tax collector": {equipment: [
                    {name: "Shortsword", type: "weapon", ability: "Strength", damage: "1d6", properties: ["finesse", "light"], damageType: "piercing"},
                    {name: "50 cp", type: "wealth"}]},
                "Town guard": {equipment: [
                    {name: "Morningstar", type: "weapon", ability: "Strength", damage: "1d4", property: "versatile", damageType: "bludgeoning"}, 
                    {armor: {desc: "buckler shield", type: "shield"}}]},
                "Urchin": {equipment: [
                    {name: "Crude shank", type: "weapon", ability: "Strength", damage: "1d4", properties: ["finesse", "light", "thrown (range 20 / 60 feet)"], damageType: "piercing"},
                    {name: "begging bowl", type: "flavor"}]},
                "Vagabond": {equipment: [
                    {name: "Big branch", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, versatile: true, damageType: "bludgeoning"},
                    {name: "winter blanket", type: "equipment"}]},
                "Wandering mystic": {equipment: [
                    {name: "Quarterstaff", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, versatile: true, damageType: "bludgeoning"},
                    {name: "spell scroll of shocking grasp", type: "scroll"},
                    {name: "gold amulet worth 10 gp", type: "flavor"}]},
                "Whaler": {equipment: [
                    {name: "Boarding knife", type: "weapon", ability: "Strength", damage: {oneHand: "1d6", twoHand: "1d8"}, properties: ["versatile", "thrown (range 20/60 feet)"], damageType: "piercing"},
                    {name: "scrimshaw octopus", type: "flavor"}]},
            };
            const trinkets = [
                "A glass jar wrapped in strips of black leather. It contains a pair of large, lazy bees.",
                "An age-worn silver pipe, carved with the name of a long-dead relative.",
                "A poppet carved from wood and bound with dried vines. Did you make it yourself or acquire it somehow?",
                "A stuffed bear with a delightfully plump tummy. It smells vaguely of chocolate.",
                "A pocket-size book coated in thick wax. What mysteries does it contain?",
                "A piece of natural glass dug up from a beach. It is shaped like a horn and whistles when you blow into it.",
                "A copper knife, the blade broken into two pieces and bound together with hide. What do the strange sigils in the metal mean?",
                "A heavy padlock only you know the combination to.",
                "A red velvet mask, twisted in an unsettling manner. Who gifted it to you?",
                "A fingerless glove made of the finest chain attached to sturdy black rings. Why is it always cold?",
                "A green glass pendant in the shape of a rare and unusual leaf",
                "A wooden statuette charred by fire. What tiny and forgotten god does it depict? Are you sure?",
                "A small music box with a delicate paper figurine that spins on the spot. Why is the music it plays special to you?",
                "A worn leather dice pouch embroidered with your initials",
                "A set of glass powder pots, each containing a few pinches of different pigments. What will you do when they run out?",
                "An old scroll case carved from yew and finished to a fine luster. What did it once contain?",
                "A leathery goblin head, shrunken and suspended from a chain. Is it real?",
                "A cheap metal tin filled with wax, containing a mold for half a key. Its partner is missing, and you don't know what the key would open if you had it.",
                "A glass figurine filled with roiling gray smoke.",
                "A fine walking stick, banded with black iron and carved with strange runes."];

            const defaultSkills = [
                {name: "Acrobatics", ability: "Dexterity"},
                {name: "Animal Handling", ability: "Wisdom"},
                {name: "Arcana", ability: "Intelligence"},
                {name: "Athletics", ability: "Strength"},
                {name: "Deception", ability: "Charisma"},
                {name: "History", ability: "Intelligence"},
                {name: "Insight", ability: "Wisdom"},
                {name: "Intimidation", ability: "Charisma"},
                {name: "Investigation", ability: "Intelligence"},
                {name: "Medicine", ability: "Wisdom"},
                {name: "Nature", ability: "Intelligence"},
                {name: "Perception", ability: "Wisdom"},
                {name: "Performance", ability: "Charisma"},
                {name: "Persuasion", ability: "Charisma"},
                {name: "Religion", ability: "Intelligence"},
                {name: "Sleight of Hand", ability: "Dexterity"},
                {name: "Stealth", ability: "Dexterity"},
                {name: "Survival", ability: "Wisdom"},
                ];
            // Dice rollers
            function rollDie(sides) {
                return Math.floor(Math.random() * sides) + 1;
            }
            function roll4d6DropLowest() {
                let rolls = [rollDie(6), rollDie(6), rollDie(6), rollDie(6)];
                rolls.sort((a,b)=>a-b);
                return rolls[1] + rolls[2] + rolls[3]; // sum top 3
            }

            function rollAbilities() {
                return {
                    Strength: roll4d6DropLowest(),
                    Dexterity: roll4d6DropLowest(),
                    Constitution: roll4d6DropLowest(),
                    Intelligence: roll4d6DropLowest(),
                    Wisdom: roll4d6DropLowest(),
                    Charisma: roll4d6DropLowest(),
                }
            }
            // Ability modifier
            function modifier(score) {
                return Math.floor((score - 10) / 2);
            }

            function randomFrom(array) {
                return array[Math.floor(Math.random() * array.length)];
            }

            // armor class calculation
            function calculateAC(abilities, occ) {
                const dexMod = modifier(abilities.Dexterity);
                let baseAC = 9 + dexMod; // default, no armor

                if (occ.armor) {
                    if (occ.armor.type === "light") {
                        baseAC = occ.armor.base + dexMod; // light armor
                    } else if (occ.armor.type === "medium") {
                        baseAC = occ.armor.base + Math.min(dexMod, 2);
                    }
                    if (occ.armor.type === "shield") {
                        baseAC += 2
                    }
            }
                return baseAC;
            }

            function randomChoice(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            function randomName() {
                const name = ["Arin", "Belkal", "Corin", "Dasa", "Eryn", "Fen", "Gilda", "Haru", "Ilya", "Jory", "Kael", "Lessa"]
                const surname = ["Blackbriar", "Coppersong", "Dawnspear", "Emberfall", "Frostwind", "Goldriver", "Ironbranch", "Nightbloom", "Oakenshield", "Quickstep", "Stormwatch", "Thistledown"]
                return randomChoice(name) + " " + randomChoice(surname)
            }

            function renderEquipment(equipment = [], includeShield = false) {
                if (!Array.isArray(equipment)) equipment = [];

                const wrapper = document.createElement("div");
                wrapper.className = "equipment-block";

                const header = document.createElement("h3");
                header.textContent = "Equipment";
                wrapper.appendChild(header);

                const list = document.createElement("ul");

                equipment.forEach(item => {
                    const li = document.createElement("li");
                    let text = item.name;

                    switch (item.type) {
                    case "weapon":
                        text += ` (Weapon, ${item.damage}`;
                        if (item.ability) text += `, uses ${item.ability}`;
                        if (item.properties?.length) text += `, properties: ${item.properties.join(", ")}`;
                        text += ")";
                        break;

                    case "armor":
                        text += ` (Armor${item.base ? `, base AC ${item.base}` : ""})`;
                        break;

                    case "shield":
                        text += " (Shield, +2 AC)";
                        break;

                    // "flavor" or unknown just prints the name
                    default:
                        if (item.notes) {
                            text += ` (${item.notes})`;
                        }
                        break;
                    }

                    li.textContent = text;
                    list.appendChild(li);
                });

                if (includeShield) {
                    const li = document.createElement("li");
                    li.textContent = "Shield (Shield, +2 AC)";
                    list.appendChild(li);
                }

                wrapper.appendChild(list);
                return wrapper;
                }

            function abilitiesText(abilities) {
                return Object.entries(abilities)
                    .map(([key, val]) => {
                        const mod = Math.floor((val - 10) / 2);
                        return `${key}: ${val} (${mod >= 0 ? "+" : ""}${mod})`;
                    })
                    .join(", ");
            }

            function skillsText(skills) {
                return skills.map(skill => `□ ${skill}`).join(", ");
            }

            function generateAttacks(equipment = [], abilities = {}, proficiency = 2, options = {}) {
                const attacks = [];

                // ensure safe ability values
                const STR = abilities.Strength ?? 10;
                const DEX = abilities.Dexterity ?? 10;

                // 1) Unarmed strike (always Strength)
                const unarmedMod = modifier(STR);
                const baseUnarmed = 1;
                const unarmedDamage = Math.max(1, baseUnarmed + unarmedMod);
                attacks.push({
                    name: "Unarmed Strike",
                    toHit: proficiency + unarmedMod,
                    damageDice: null, // simple 1 base damage for unarmed in this system
                    damageMod: unarmedMod,
                    damageText: `${unarmedDamage} bludgeoning damage`,
                    abilityUsed: "Strength"
                });

                // 2) Weapons from equipment (skip non-weapons)
                (Array.isArray(equipment) ? equipment : []).forEach(item => {
                    if (!item || item.type !== "weapon") return;

                    // determine ability used (finesse handling)
                    let abilityUsed = item.ability || "Strength";
                    if (Array.isArray(item.properties) && item.properties.includes("finesse")) {
                    const strMod = modifier(STR);
                    const dexMod = modifier(DEX);
                    abilityUsed = (dexMod >= strMod) ? "Dexterity" : "Strength";
                    }

                    const mod = modifier(abilities[abilityUsed] ?? 10);
                    const toHit = mod + (typeof proficiency === "number" ? proficiency : 2);

                    // pick damage dice (string) — support "damage" as string or object { oneHand, twoHand }
                    let damageDice = "1";
                    if (typeof item.damage === "string") {
                        damageDice = item.damage;
                    } else if (item.damage && typeof item.damage === "object") {
                    if (item.versatile && options.useTwoHanded) {
                        damageDice = item.damage.twoHand || item.damage.oneHand || "1";
                    } else {
                        damageDice = item.damage.oneHand || item.damage.twoHand || "1";
                    }
                    }

                    // include damage type
                    const damageType = item.damageType || "bludgeoning";

                    // build display text for damage
                    const damageText = `${damageDice} ${mod >= 0 ? `+ ${mod}` : `- ${Math.abs(mod)}`} ${damageType} damage`;

                    // notes: include properties (except finesse which we've used), mention versatile handedness
                    const props = Array.isArray(item.properties) ? item.properties.filter(p => p !== "finesse") : [];
                    const notesParts = [];
                    if (props.length) notesParts.push(props.join(", "));
                    if (item.versatile) notesParts.push(options.useTwoHanded ? "two-handed (versatile)" : "one-handed (versatile)");
                    const notes = notesParts.length ? notesParts.join("; ") : undefined;

                    attacks.push({
                    name: item.name,
                    toHit,
                    damageDice,
                    damageMod: mod,
                    damageText,
                    abilityUsed,
                    notes
                    });
                });

                return attacks;
                }

            const characters = [];

            function generateCharacter() {
                const container = document.getElementById("characterSheet") || (() => {
                    const c = document.createElement("div");
                    c.id = "characterSheet";
                    document.body.appendChild(c);
                    return c;
                })();

                // --- Generate character ---
                const ancestryName = randomChoice(Object.keys(ancestries));
                const occupationName = randomChoice(Object.keys(occupations));
                const occupation = occupations[occupationName];
                const abilities = rollAbilities();
                const skills = defaultSkills.map(s => {
                    const baseMod = modifier(abilities[s.ability]); // ability modifier
                    return {
                        name: s.name,
                        ability: s.ability,
                        modifier: baseMod,
                    };
                    });
                const proficiencyBonus = 2;
                const hp = Math.max(1, rollDie(4) + modifier(abilities.Constitution));
                const ac = calculateAC(abilities, occupation.equipment);
                const attacks = generateAttacks(occupation.equipment, abilities, proficiencyBonus);

                const character = {
                    name: randomName(),
                    ancestry: ancestryName,
                    occupation: occupationName,
                    abilities,
                    skills: defaultSkills.map(s => ({
                        name: s.name,
                        ability: s.ability,
                        proficient: false
                    })),
                    proficiencyBonus,
                    hp,
                    ac,
                    equipment: occupation.equipment,
                    trinket: randomChoice(trinkets),
                    attacks
                };

                // --- Character card ---
                const charDiv = document.createElement("div");
                charDiv.className = "character-card";

                // Name
                const nameHeader = document.createElement("h2");
                nameHeader.textContent = character.name;
                charDiv.appendChild(nameHeader);

                // Ancestry + Occupation (subtitle)
                const subtitle = document.createElement("h3");
                subtitle.className = "char-subtitle";
                subtitle.textContent = `${character.ancestry}, ${character.occupation}`;
                charDiv.appendChild(subtitle);

                // Stats row
                const statsDiv = document.createElement("div");
                statsDiv.className = "stats-block";
                statsDiv.innerHTML = `
                    <strong>Proficiency Bonus:</strong> +${character.proficiencyBonus}
                    &nbsp;&nbsp;&nbsp;
                    <strong>Armor Class:</strong> ${character.ac}
                    &nbsp;&nbsp;&nbsp;
                    <strong>Hit Points:</strong> ${character.hp}
                `;
                charDiv.appendChild(statsDiv);

                // Abilities
                const abilitiesDiv = document.createElement("div");
                abilitiesDiv.className = "abilities-block";
                const abHeader = document.createElement("h3");
                abHeader.textContent = "Abilities";
                abilitiesDiv.appendChild(abHeader);
                const abRow = document.createElement("div");
                abRow.className = "abilities-row";

                for (const [ability, score] of Object.entries(character.abilities)) {
                    const mod = modifier(score);
                    const box = document.createElement("div");
                    box.className = "ability-box";

                    const cb = document.createElement("input");
                    cb.type = "checkbox";
                    cb.dataset.ability = ability;
                    box.appendChild(cb);
                    box.appendChild(document.createTextNode(` ${ability.slice(0,3)}: ${score} (${mod >=0 ? '+' + mod : mod})`));
                    abRow.appendChild(box);
                }
                abilitiesDiv.appendChild(abRow);
                charDiv.appendChild(abilitiesDiv);

                // Skills
                const skillsDiv = document.createElement("div");
                skillsDiv.className = "skills-block";
                const skHeader = document.createElement("h3");
                skHeader.textContent = "Skills";
                skillsDiv.appendChild(skHeader);

                const skGrid = document.createElement("div");
                skGrid.className = "skills-grid";
                character.skills.forEach(skill => {
                    const box = document.createElement("div");
                    box.className = "skill-box";

                     // Checkbox
                    const cb = document.createElement("input");
                    cb.type = "checkbox";
                    cb.dataset.skill = skill.name;
                    box.appendChild(cb);
                    
                    // skill modifier (ignore proficiency)
                    const abilityScore = character.abilities[skill.ability];
                    const mod = modifier(abilityScore);

                    // text with bonus
                    const label = document.createTextNode(
                        ` ${skill.name} (${mod >= 0 ? "+" : ""}${mod})`
                    );
                    box.appendChild(label);

                    skGrid.appendChild(box);
                });
                skillsDiv.appendChild(skGrid);
                charDiv.appendChild(skillsDiv);

                // Equipment
                charDiv.appendChild(renderEquipment(character.equipment));

                // Attacks
                const atkDiv = document.createElement("div");
                atkDiv.className = "attacks-block";
                const atkHeader = document.createElement("h3");
                atkHeader.textContent = "Attacks";
                atkDiv.appendChild(atkHeader);
                const atkList = document.createElement("ul");
                character.attacks.forEach(atk => {
                    const li = document.createElement("li");
                    li.textContent = `${atk.name}: ${atk.toHit >=0 ? '+'+atk.toHit : atk.toHit} to hit, ${atk.damageText}${atk.notes ? ` (${atk.notes})` : ''}`;
                    atkList.appendChild(li);
                });
                atkDiv.appendChild(atkList);
                charDiv.appendChild(atkDiv);

                // Trinket
                const trktHeader = document.createElement("h3");
                trktHeader.textContent = "Trinket";
                atkDiv.appendChild(trktHeader);
                const trinketEl = document.createElement("p");
                const li = document.createElement("li");
                trinketEl.textContent = `${character.trinket}`;
                charDiv.appendChild(trinketEl);

                container.appendChild(charDiv);

                // Store globally
                if (!Array.isArray(window.characters)) window.characters = [];
                window.characters.push(character);
                }

            function clearCharacters() {
                const container = document.getElementById("characterSheet");
                if (container) container.innerHTML = "";
                window.characters = [];
                }

            async function exportPDF() {
                if (!window.characters || window.characters.length === 0) {
                    alert("No characters to export!");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF("p", "pt", "a4");
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let yOffset = 20;

                const cards = document.querySelectorAll(".character-card");
                for (const card of cards) {
                    const canvas = await html2canvas(card, { scale: 2 });
                    const imgData = canvas.toDataURL("image/png");
                    const pdfWidth = pageWidth - 40;
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                    if (yOffset + pdfHeight > pageHeight) {
                    doc.addPage();
                    yOffset = 20;
                    }

                    doc.addImage(imgData, "PNG", 20, yOffset, pdfWidth, pdfHeight);
                    yOffset += pdfHeight + 10;
                }

                doc.save("characters.pdf");
                }

        </script>
    </body>
</html>